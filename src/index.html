<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>webpack-minimal</title>
    <link href="https://fonts.googleapis.com/css?family=Fredoka+One" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <style>
     .canvas {
         cursor: none;
     }
    </style>
</head>
<body>
<section>
  <div id="app"></div>

  <div id="controls">
    <button id="pay_toll">Pay Toll</button>
    <button id="prompt_roll">Prompt Roll</button>
    <button id="prompt_buycity">Prompt Buy City</button>
    <button id="dice_roll">Dice Roll</button>
    <button id="move">Move</button>
  </div>
</section>

<script>

const promiseSerial = funcs =>
  funcs.reduce((promise, func) =>
    promise.then(result => func().then(Array.prototype.concat.bind(result))),
    Promise.resolve([]))

 const server = new City.Server();

 var config = {
   events: {
     noBuyland: () => {
       server.send('player2', { uci: 'nobuyland' });
     },
     roll: () => {
       server.send('player2', { uci: 'roll' });
     },
     onLoad: () => { init(api); }
   }
 };

 function init(api) {
 
   const handlers = {
     move(o) {
       const oldTurnColor = config.turns % 2 === 0 ? 'player1':'player2';
       config.turns = o.turns;
       config.turnColor = o.turns % 2 === 0 ? 'player1':'player2';
       const myTurn = config.turnColor === 'player2';

       api.clearCamera();

       const reqs = o.events.map(event => {
         if (event.roll) {
           return () =>
             api.roll(event.roll[0], event.roll[1]);
         }
         if (event.move) {
           return () => api.move(event.move);
         }
       });
       return promiseSerial(reqs).then(() => {
         if (o.prompt === 'roll') {
           if (myTurn) {
             api.promptRoll();
           }
         } else if (o.prompt === 'buycity') {
           if (myTurn) {
             api.promptBuyCity();
           }
         }
         api.set({
           turnColor: config.turnColor
         });
       });
     }
   };

   const socket = new City.Socket(handlers);
   server.connect('player2', socket);

   const data = server.get();
   setData(config, data);
 }

 const api = City(document.getElementById('app'), config);
 
 function setData(config, data) {
   config.players = data.players;
   config.tolls = data.tolls;
   config.playerColor = data.playerColor;
   config.turnColor = data.turnColor;
   config.prompt = data.prompt;
 }


 const elPayToll = document.getElementById('pay_toll');
 const elPromptRoll = document.getElementById('prompt_roll');
 const elPromptBuyCity = document.getElementById('prompt_buycity');
 const elDiceRoll = document.getElementById('dice_roll');
 const elMove = document.getElementById('move');

 onClick(elPayToll, function() {
   api.payToll('player1', 'player2', 'seoul');
 });

 onClick(elPromptRoll, function() {
   api.promptRoll();
 });

 onClick(elPromptBuyCity, function() {
   api.promptBuyCity();
 });

 onClick(elMove, function() {
   api.move(8);
 });

 function onClick(button, f) {
   button.addEventListener('click', f);
 }
 
</script>

</body>
</html>
