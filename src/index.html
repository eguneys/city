<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>webpack-minimal</title>
    <link href="https://fonts.googleapis.com/css?family=Fredoka+One" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <style>
     .canvas {
         cursor: none;
     }
    </style>
</head>
<body>
<section>
  <div id="app"></div>

  <div id="controls">
    <button id="pay_toll">Pay Toll</button>
    <button id="prompt_roll">Prompt Roll</button>
    <button id="prompt_buycity">Prompt Buy City</button>
    <button id="dice_roll">Dice Roll</button>
    <button id="move">Move</button>
  </div>
</section>

<script>

const promiseSerial = funcs =>
  funcs.reduce((promise, func) =>
    promise.then(result => func().then(Array.prototype.concat.bind(result))),
    Promise.resolve([]))

 function init(api) {
 
   const handlers = {
     move(o) {
       const reqs = o.events.map(event => {
         if (event.roll) {
           return () =>
             api.roll(event.roll[0], event.roll[1]);
         }
         if (event.move) {
           return () => api.move(event.move);
         }
       });
       promiseSerial(reqs);
     }
   };
   
   const server = new City.Server();

   server.connect('player1', handlers);

   const data = server.get();
   setData(config, data);
 }

 var config = {
   events: {
     noBuyland: () => {
       api.clearBuyCity();
       api.clearCamera();
       endTurn();
     },
     roll: () => {
       api.clearRoll();
       diceRoll();
     },
     onLoad: () => { init(api); }
   }
 };

 const api = City(document.getElementById('app'), config);
 
 function afterDiceRoll(dice) {
   api.move(dice);
 }

 function afterUserMove() {
   const state = api.getState();

   const isMyTurn = state.turnColor === state.playerColor;

   const ownPlayer = state.playerColor;
   const turnPlayer = state.players[state.turnColor],
         currentTile = state.tiles[turnPlayer.currentTile];

   if (!isMyTurn) {
     if (currentTile.type === 'city') {
       api.buyCity('land');
     }
     api.set({
       turnColor: 'player2'
     });
   } else if (currentTile.type === 'city') {
     api.promptBuyCity();
   } else {
     endTurn();
   }

 }

 function setData(config, data) {
   config.players = data.players;
   config.tolls = data.tolls;
   config.playerColor = data.playerColor;
   config.turnColor = data.turnColor;
   config.prompt = data.prompt;
 }


 const elPayToll = document.getElementById('pay_toll');
 const elPromptRoll = document.getElementById('prompt_roll');
 const elPromptBuyCity = document.getElementById('prompt_buycity');
 const elDiceRoll = document.getElementById('dice_roll');
 const elMove = document.getElementById('move');

 onClick(elPayToll, function() {
   api.payToll('player1', 'player2', 'seoul');
 });

 onClick(elPromptRoll, function() {
   api.promptRoll();
 });

 onClick(elPromptBuyCity, function() {
   api.promptBuyCity();
 });

 onClick(elDiceRoll, function() {
   diceRoll();
 });

 onClick(elMove, function() {
   api.move(8);
 });

 function endTurn() {
   api.set({
     turnColor: 'player1'
   });
 }

 function diceRoll() {
   const dice1 = Math.floor((Math.random() * 6)) + 1;
   const dice2 = Math.floor((Math.random() * 6)) + 1;

   api.roll(dice1, dice2);
 }

 function onClick(button, f) {
   button.addEventListener('click', f);
 }
 
</script>

</body>
</html>
