<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>webpack-minimal</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Fredoka+One" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Luckiest+Guy" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <style>
     .canvas {
         cursor: none;
     }
    </style>
</head>
<body>
<section>
  <div id="app"></div>

  <div id="controls">
    <button id="citySelect"> Select city</button>
  </div>
</section>

<script>

const promiseSerial = funcs =>
  funcs.reduce((promise, func) =>
    promise.then(result => func().then(Array.prototype.concat.bind(result))),
    Promise.resolve([]))

 const api = init();
 const tests = new City.Tests();
 tests.run();

 function init() {
 
   const handlers = {
     move(o) {
       config.turns = o.turns;
       config.turnColor = o.turns % 2 === 1 ? 'player1':'player2';
       const myTurn = config.turnColor === 'player2';

       api.clearCamera();

       const reqs = o.events.map(event => {
         if (event.roll) {
           return () =>
             api.roll(event.roll[0], event.roll[1]);
         }
         if (event.move) {
           return () => api.move(event.move);
         }
         if (event.buy) {
           return () => api.buyCity(event.buy);
         }
         if (event.chance) {
           return () => api.chance(event.chance);
         }
         if (event.toll) {
           const showPaytoll = o.events.filter(e => !!e.bankrupt).length === 0;
           return () => api.payToll(showPaytoll);
         }
         if (event.bankrupt) {
           return () => api.bankrupt();
         }
         if (event.sell) {
           return () => api.sell(event.sell);
         }
         return () => Promise.reject("Unhandled move event " + JSON.stringify(event));
       });
       return promiseSerial(reqs).then(() => {
         if (o.prompt === 'roll') {
           if (myTurn) {
             api.promptRoll();
           }
         } else if (o.prompt === 'buycity') {
           if (myTurn) {
             api.promptBuyCity();
           }
         } else if (o.prompt === 'sell') {
           if (myTurn) {
             api.promptSell(o.needMoney);
           }
         }
         api.set({
           turnColor: config.turnColor,
           turns: config.turns
         });
       }).catch(err => {
         throw err;
         reload();
       });
     },
     end({winner}) {
       if (winner === config.playerColor) {
         api.youWin();
       } else {
         api.youLose();
       }
     }
   };

  var config = {
     events: {
       noBuyland: () => {
         server.send('player2', { uci: 'nobuy' });
       },
       buyland: (type) => {
         server.send('player2', { uci: 'buy', type });
       },
       roll: () => {
         server.send('player2', { uci: 'roll' });
       },
       sellcities: (cities) => {
         server.send('player2', { uci: 'sell', cities });
       },
       onLoad: () => {
         server.connect('player2', socket);

         const data = server.get();
         setData(config, data);
       }
     }
   };

   const server = new City.Server();
   const socket = new City.Socket(handlers);

   const api = City(document.getElementById('app'), config);

   return api;
 }

 function reload() {
   console.log('reload');
  const data = server.get();
   setData(config, data);
 }

 function setData(config, data) {
   config.players = data.players;
   config.tolls = data.tolls;
   config.turns = data.turns;
   config.playerColor = data.playerColor;
   config.turnColor = data.turnColor;
   config.prompt = data.prompt;
   api.set(config);
 }

 onClick(document.getElementById('citySelect'), (e) => {
   api.selectCity(100);
 });

 function onClick(button, f) {
   button.addEventListener('click', f);
 }
 
</script>

</body>
</html>
